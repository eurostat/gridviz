<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <title></title>
</head>

<body style="margin: 0; height:100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden;">
    <div id="viz-container" style="height:100%; width:100%;"></div>

    <div
        style="position: absolute; left: 20px; top: 20px; width: auto; height: auto; padding: 10px; border: 0px; border-radius: 5px; background: #FFFFFFCC; line-height: 1.6; box-shadow: 5px 5px 5px grey">
        <span style="font-size: 17pt; font-weight: bold;">France grid</span><span style="font-size: 10pt;">
            <div id="layer">
                <input type="radio" name="layer" id="pop" value="pop" checked>
                <label for="pop">Population</label>
                <input type="radio" name="layer" id="popAge" value="popAge" checked>
                <label for="popAge">by age</label>
                <input type="radio" name="layer" id="popAge3" value="popAge3" checked>
                <label for="popAge3">by age (3)</label>
                <br>
                <input type="radio" name="layer" id="income" value="income">
                <label for="income">Income</label>
                <input type="radio" name="layer" id="poverty" value="poverty">
                <label for="poverty">Poverty</label>
            </div>
            <hr>
            <input type="checkbox" id="label" checked>
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked>
            <label for="boundary">Boundaries</label>
            <hr>Source: <a href="https://www.insee.fr/fr/statistiques/4176290?sommaire=4176305" target="_blank"
                rel="noopener noreferrer">INSEE - Filosofi 2015 - 200m grid</a>
        </span>
    </div>

    <div id="zoomSlider" style="display: block; position: absolute; right: 20px; top: 20px;"></div>

    <script src="../build/gridvizc.js"></script>
    <script>

        let containerDiv = document.getElementById("viz-container");
        const app = new gviz.App(containerDiv)
            .setGeoCenter({ x: 3763437, y: 2891045 }).setZoomFactor(50.1).setZoomFactorExtent([10, 2000])
            .addZoomSlider("zoomSlider")
            .setLabelLayer(gviz.getEuronymeLabelLayer("FR", "20"))
            .setBoundaryLayer(gviz.getEurostatBoundariesLayer())
            .setViewFromURL()

            //population
            .addMultiScaleTiledGridLayer(
                "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi_2015/",
                [200, 400, 1000, 2000, 5000, 10000, 20000, 50000],
                r => r + "m/",
                [
                    new gviz.SquareColoringWebGLStyle({
                        colorCol: "Ind",
                        color: (v, r, s) => gviz.interpolateOrRd(gviz.s(v / s.max, 0.25)),
                    }), new gviz.StrokeStyle({ zf: 15 })
                ],
                {
                    pixNb: 5,
                    cellInfoHTML: c => "<b>" + c["Ind"] + "</b> inhabitant(s)"
                }
            )

            //population by age
            //population by age 3
            /*

            app.addMultiScaleTiledGridLayer(
            "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi_2015/",
            [200, 400, 1000, 2000, 5000, 10000, 20000, 50000],
            r => r + "m/",
            [getStyle()],
            {
                pixNb : 25,
                cellInfoHTML: c => {
                    let out = "<b>" + c["Ind"] + "</b> inhabitant(s)<br>" + "By age:<br>"
                    if (getAggUI()) {
                        out = out + "  < 18: " + d3.format(".1f")(c["Ind_0_17"]) + "<br>" +
                            " 18-64: " + d3.format(".1f")(c["Ind_18_64"]) + "<br>" +
                            "  > 65: " + d3.format(".1f")(c["Ind_65p"]) + "<br>" +
                            " unk.: " + d3.format(".1f")(c["Ind_inc"]) + "<br>";
                    } else {
                        out = out + " < 3 : " + (c["Ind_0_3"]) + "<br>" +
                            " 4-5 : " + (c["Ind_4_5"]) + "<br>" +
                            " 6-10: " + (c["Ind_6_10"]) + "<br>" +
                            "11-17: " + (c["Ind_11_17"]) + "<br>" +
                            "18-24: " + (c["Ind_18_24"]) + "<br>" +
                            "25-39: " + (c["Ind_25_39"]) + "<br>" +
                            "40-54: " + (c["Ind_40_54"]) + "<br>" +
                            "55-64: " + (c["Ind_55_64"]) + "<br>" +
                            "65-79: " + (c["Ind_65_79"]) + "<br>" +
                            " > 80: " + (c["Ind_80p"]) + "<br>" +
                            " unk.: " + (c["Ind_inc"]) + "<br>";
                    }
                    return out
                },
                preprocess: c => {
                    c["Ind_0_17"] = +c["Ind_0_3"] + +c["Ind_4_5"] + +c["Ind_6_10"] + +c["Ind_11_17"]
                    c["Ind_18_64"] = +c["Ind_18_24"] + +c["Ind_25_39"] + +c["Ind_40_54"] + +c["Ind_55_64"]
                    c["Ind_65p"] = +c["Ind_65_79"] + +c["Ind_80p"]
                    //c["Ind_0_24"] = +c["Ind_0_3"] + +c["Ind_4_5"] + +c["Ind_6_10"] + +c["Ind_11_17"] + +c["Ind_18_24"]
                    //c["Ind_25_54"] = +c["Ind_25_39"] + +c["Ind_40_54"]
                    //c["Ind_55p"] = +c["Ind_55_64"] + +c["Ind_65_79"] + +c["Ind_80p"]
                }
            })
            
            
                    const col = gviz.interpolateSpectral
        //const col = gviz.interpolateRdYlBu
        //const col = gviz.interpolateTurbo
        //const col = gviz.interpolateYlOrRd
        //const col = gviz.interpolateRainbow
        const getColorDict = () => {
            if (getAggUI())
                return {
                    "Ind_0_17": col(0.2),
                    "Ind_18_64": col(0.4),
                    "Ind_65p": col(0.9),
                };
            else
                return {
                    "Ind_0_3": col(0 / 80),
                    "Ind_4_5": col(2 / 80),
                    "Ind_6_10": col(7 / 80),
                    "Ind_11_17": col(14 / 80),
                    "Ind_18_24": col(21 / 80),
                    "Ind_25_39": col(36 / 80),
                    "Ind_40_54": col(51 / 80),
                    "Ind_55_64": col(61 / 80),
                    "Ind_65_79": col(76 / 80),
                    "Ind_80p": col(1),
                    //"Ind_inc": "black"
                }
        }


            //style
            const s = new gviz.CompositionStyle({
            color: getColorDict(),
            type: () => "agepyramid",
            sizeCol: "Ind",
            size: (v, r, s, zf) => r * gviz.s(v / s.max, 0.1, 0),
            agePyramidHeight: (r) => 0.95 * r
        })
        s.size_ = (v, r, s, zf) => r - 1.5 * zf

        */

            //income
            .addMultiScaleTiledGridLayer(
                "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi_2015/",
                [200, 400, 1000, 2000, 5000, 10000, 20000, 50000],
                r => r + "m/",
                [
                    new gviz.SquareColoringWebGLStyle({
                        colorCol: "r",
                        color: (v, r, s) => gviz.interpolateSpectral(1 - Math.pow((v - s.min) / (s.max - s.min), 1.5)),
                    }),
                    new gviz.StrokeStyle({ zf: 15 })
                ],
                {
                    pixNb: 4,
                    cellInfoHTML: c => "<b>" + Math.floor(c.r) + "€</b>/mois/'personne'",
                    preprocess: c => { c.r = c["Ind_snv"] / c["Ind"] / 12; }
                })

            //poverty
            .addMultiScaleTiledGridLayer(
                "https://raw.githubusercontent.com/eurostat/gridviz/master/assets/csv/France/filosofi_2015/",
                [200, 400, 1000, 2000, 5000, 10000, 20000, 50000],
                r => r + "m/",
                [
                    new gviz.SquareColoringWebGLStyle({
                        colorCol: "r",
                        color: (v, r, s) => {
                            return gviz.interpolateSpectral(1 - Math.pow(v / s.max, 0.7))
                        },
                    }),
                    new gviz.StrokeStyle({ zf: 15 })
                ],
                {
                    pixNb: 4,
                    cellInfoHTML: c => "<b>" + (Math.floor(1000 * c.r) / 10) + "%</b> of poor households.",
                    preprocess: c => { c.r = c["Men_pauv"] / c["Men"]; }
                })



        //
        const update = () => {

            //read GUI selection
            const layCode = document.querySelector('input[name="layer"]:checked').value

            //hide layers
            app.hideAllLayers()

            if (layCode === "pop") app.layers[0].visible = true;
            else if (layCode === "income") app.layers[1].visible = true;
            else if (layCode === "poverty") app.layers[2].visible = true;
            else {
                console.error("Unexpected layer code: " + layCode);
                return;
            }

            //redraw
            app.cg.redraw();
        }



        //layer selector
        document.querySelector('#layer').addEventListener('change', update)

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            app.showLabels = this.checked
            app.cg.redraw();
        });

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            app.showBoundaries = this.checked
            app.cg.redraw();
        });

        //initialise
        update()

    </script>

    <div
        style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
        <span style="font-size: 8pt;"><a href="https://github.com/eurostat/gridviz"
                style="text-decoration:none">GridViz</a> |
            © <a href="https://eurogeographics.org" style="text-decoration:none">EuroGeographics</a></span>
    </div>

</body>

</html>