<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title></title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="viz-container" style="height: 100%; width: 100%"></div>

    <div style="
                position: absolute;
                left: 20px;
                top: 20px;
                width: auto;
                height: auto;
                padding: 10px;
                border: 0px;
                border-radius: 5px;
                background: #ffffffcc;
                line-height: 1.6;
                box-shadow: 5px 5px 5px grey;
            ">
        <span style="font-size: 1.8em; font-weight: bold">Population of France by age</span><br />
        <span style="font-size: 1.25em">
            <input type="checkbox" id="agg" />
            <label for="agg">Aggregate to 3 age groups</label>
            <hr />
            <span style="font-size: 1.25em; font-weight: bold">Style</span><br />
            <div id="style">
                <input type="radio" name="style" id="flag" value="flag" checked />
                <label for="flag">Flag</label>
                <input type="radio" name="style" id="segment" value="segment" />
                <label for="segment">Segment</label>
                <input type="radio" name="style" id="agepyramid" value="agepyramid" />
                <label for="agepyramid">Age pyramid</label>
                <br />
                <input type="radio" name="style" id="ring" value="ring" />
                <label for="ring">Ring</label>
                <input type="radio" name="style" id="radar" value="radar" />
                <label for="radar">Radar</label>
                <input type="radio" name="style" id="piechart" value="piechart" />
                <label for="piechart">Pie chart</label>
                <input type="radio" name="style" id="halftone" value="halftone" />
                <label for="halftone">Halftone</label>
            </div>
            <input type="checkbox" id="adsize" checked />
            <label for="adsize">Size to total population</label>
            <hr />
            <input type="checkbox" id="label" checked />
            <label for="label">City names</label>
            <input type="checkbox" id="boundary" checked />
            <label for="boundary">Boundaries</label>
            <hr />
            Source:
            <a href="https://www.insee.fr/fr/statistiques/4176290?sommaire=4176305" target="_blank"
                rel="noopener noreferrer">INSEE - Filosofi 2015 - 200m grid</a>
        </span>
    </div>

    <script src="../../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridviz-eurostat@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script>
        let containerDiv = document.getElementById('viz-container')
        const map = new gviz.Map(containerDiv)
            .setGeoCenter({ x: 3763437, y: 2891045 })
            .setZoom(100)
            .setZoomExtent([5, 1500])
            .setLabelLayer(
                gviz_es.getEuronymeLabelLayer('FR', '20', {
                    haloWidth: () => 5,
                    haloColor: () => '#FFFFFFDD',
                })
            )
            .setBoundaryLayer(
                gviz_es.getEurostatBoundariesLayer({
                    color: (f, zf) => {
                        const p = f.properties
                        const col = '#888'
                        if (p.co === 'T') return col //"#007577"
                        if (zf < 400) return col
                        else if (zf < 1000) return p.lvl >= 3 ? '' : col
                        else if (zf < 2000) return p.lvl >= 2 ? '' : col
                        else return p.lvl >= 1 ? '' : col
                    },
                    lineDash: () => [],
                })
            )
            .setViewFromURL()

        //get aggregation from UI
        const getAggUI = () => {
            return document.querySelector('#agg').checked
        }

        //get style from UI
        const getStyle = () => {
            const v = document.querySelector('input[name="style"]:checked').value
            s.type = () => v
            return s
        }

        const col = d3.interpolateSpectral
        //const col = d3.interpolateRdYlBu
        //const col = d3.interpolateTurbo
        //const col = d3.interpolateYlOrRd
        //const col = d3.interpolateRainbow
        const getColorDict = () => {
            if (getAggUI())
                return {
                    ind_0_17: col(0.2),
                    ind_18_64: col(0.4),
                    ind_65p: col(0.9),
                    /*"ind_0_24": "#66a61e",
                "ind_25_54": "#e6ab02",
                "ind_55p": "#a6761d",*/
                    //"ind_inc": "black"
                }
            else
                return {
                    ind_0_3: col(0 / 80),
                    ind_4_5: col(2 / 80),
                    ind_6_10: col(7 / 80),
                    ind_11_17: col(14 / 80),
                    ind_18_24: col(21 / 80),
                    ind_25_39: col(36 / 80),
                    ind_40_54: col(51 / 80),
                    ind_55_64: col(61 / 80),
                    ind_65_79: col(76 / 80),
                    ind_80p: col(1),
                    //"ind_inc": "black"
                }
        }

        //style
        const s = new gviz.CompositionStyle({
            color: getColorDict(),
            type: () => 'ring',
            size: (c, r, zf, scale) => scale(+c.ind),
            viewScale: gviz.sizeQuantileScale({ valueFunction: (c) => +c.ind, classNumber: 9, minSizePix: 8 }),
            agePyramidHeight: (c, r) => 0.95 * r,
        })
        s.size_ = (c, r, zf) => r - 1.5 * zf

        map.addMultiScaleTiledGridLayer(
            [200, 400, 600, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
            (r) =>
                'https://raw.githubusercontent.com/jgaffuri/tiled-grid-france-filosofi/main/out/csv/met/ind/2019/' +
                r +
                'm/',
            [getStyle()],
            {
                minPixelsPerCell: 12,
                cellInfoHTML: (c) => {
                    let out = '<b>' + c.ind + '</b> inhabitant(s)<br>' + 'By age:<br>'
                    if (getAggUI()) {
                        out =
                            out +
                            '  < 18: ' +
                            d3.format('.1f')(c.ind_0_17) +
                            '<br>' +
                            ' 18-64: ' +
                            d3.format('.1f')(c.ind_18_64) +
                            '<br>' +
                            '  > 65: ' +
                            d3.format('.1f')(c.ind_65p) +
                            '<br>' +
                            ' unk.: ' +
                            d3.format('.1f')(c.ind_inc) +
                            '<br>'
                    } else {
                        out =
                            out +
                            ' < 3 : ' +
                            c.ind_0_3 +
                            '<br>' +
                            ' 4-5 : ' +
                            c.ind_4_5 +
                            '<br>' +
                            ' 6-10: ' +
                            c.ind_6_10 +
                            '<br>' +
                            '11-17: ' +
                            c.ind_11_17 +
                            '<br>' +
                            '18-24: ' +
                            c.ind_18_24 +
                            '<br>' +
                            '25-39: ' +
                            c.ind_25_39 +
                            '<br>' +
                            '40-54: ' +
                            c.ind_40_54 +
                            '<br>' +
                            '55-64: ' +
                            c.ind_55_64 +
                            '<br>' +
                            '65-79: ' +
                            c.ind_65_79 +
                            '<br>' +
                            ' > 80: ' +
                            c.ind_80p +
                            '<br>' +
                            ' unk.: ' +
                            c.ind_inc +
                            '<br>'
                    }
                    return out
                },
                preprocess: (c) => {
                    c.ind_0_17 = +c.ind_0_3 + +c.ind_4_5 + +c.ind_6_10 + +c.ind_11_17
                    c.ind_18_64 = +c.ind_18_24 + +c.ind_25_39 + +c.ind_40_54 + +c.ind_55_64
                    c.ind_65p = +c.ind_65_79 + +c.ind_80p
                },
            }
        )

        //add legends
        const getLegendOpts = () => {
            const opts = { title: 'Age group', shape: 'circle' }
            if (getAggUI())
                opts.colCat = [
                    [getColorDict()['ind_0_17'], '< 17'],
                    [getColorDict()['ind_18_64'], '18 to 65'],
                    [getColorDict()['ind_65p'], '> 65'],
                ].reverse()
            else
                opts.colCat = [
                    [col(0), '< 3'],
                    [col(2 / 80), '4 to 5'],
                    [col(7 / 80), '6 to 10'],
                    [col(14 / 80), '11 to 17'],
                    [col(21 / 80), '18 to 24'],
                    [col(36 / 80), '25 to 39'],
                    [col(51 / 80), '40 to 54'],
                    [col(61 / 80), '55 to 64'],
                    [col(76 / 80), '65 to 79'],
                    [col(1), '>80'],
                ].reverse()
            return opts
        }
        s.legends.push(new gviz.ColorCategoryLegend(getLegendOpts()))

        const updateStyle = () => {
            const ssel = getStyle()
            map.layers[0].styles = [ssel]
        }

        //combo list
        document.querySelector('#style').addEventListener('change', function () {
            updateStyle()
            map.cg.redraw()
        })

        // size adaptation
        document.querySelector('#adsize').addEventListener('change', function () {
            const swap = (s, col) => {
                const aux = s[col]
                s[col] = s[col + '_']
                s[col + '_'] = aux
            }
            swap(s, 'size')
            updateStyle()
            map.cg.redraw()
        })

        // aggregation
        document.querySelector('#agg').addEventListener('change', function () {
            //update classes
            s.color = getColorDict()

            //update legend
            s.legends = [new gviz.ColorCategoryLegend(getLegendOpts())]

            map.cg.redraw()
        })

        // show/hide labels
        document.querySelector('#label').addEventListener('change', function () {
            map.showLabels = this.checked
            map.cg.redraw()
        })

        // show/hide boundaries
        document.querySelector('#boundary').addEventListener('change', function () {
            map.showBoundaries = this.checked
            map.cg.redraw()
        })
    </script>

    <div style="
                position: absolute;
                right: 0px;
                bottom: 0px;
                width: auto;
                height: auto;
                padding: 1px;
                border: 0px;
                background: #ffffffcc;
            ">
        <span style="font-size: 0.8em"><a href="https://github.com/eurostat/gridviz"
                style="text-decoration: none">GridViz</a> | Â©
            <a href="https://eurogeographics.org" style="text-decoration: none">EuroGeographics</a></span>
    </div>
</body>

</html>