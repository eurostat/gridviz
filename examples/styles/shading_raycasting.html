<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gridviz hill shading raycasting example</title>
    <style>
        html,
        body {
            height: 100%;
            /* Ensure the parent elements have a height so that the map can take up 100% correctly */
            margin: 0;
            /* Remove default margins to prevent scrolling */
            overflow: hidden;
            /* Prevent potential scrollbars */
        }
    </style>
</head>

<body>
    <form id="form">
        <label for="cbHillshadingRay"><input type="checkbox" id="cbHillshadingRay" checked>Relief hillshading raycasting
            (slow)</label>
        <br>
        <label>Shading opacity</label>
        <input type="range" min="0" max="1" value="0.5" step="0.1" id="sAlpha" style="width: 200px" />
        <br>
        <label>Sun altitude</label>
        <input type="range" min="0.01" max="0.7" value="0.15" step="0.01" id="sunAltitude" style="width: 200px" />
        <br>
        <label>Sun azimuth</label>
        <input type="range" min="0" max="6.2" value="2.4" step="0.1" id="sunAzimuth" style="width: 200px" />
        <br>
        <label>Z factor</label>
        <input type="range" min="0.1" max="10" value="1" step="0.1" id="zFactor" style="width: 200px" />

    </form>
    <div id="map" style="height: 600px; width: 900px"></div>

    <script src="../../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridviz-parquet@1.1.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3.2.4"></script>
    <script>
        //define map with initial view
        const map = new gridviz.Map(document.getElementById('map'), {
            x: 4100000,
            y: 2500000,
            z: 200,
            backgroundColor: '#ede4cc',
        }).addZoomButtons()

        //define dataset
        const dataset = new gridviz.MultiResolutionDataset(
            [100, 200, 500, 1000, 2000, 5000, 10000, 20000],
            resolution => new gviz_par.TiledParquetGrid(map,
                "https://raw.githubusercontent.com/jgaffuri/tiled-euroDEM/main/pub/v1/tiles_" + resolution + "/"),
            { preprocess: (c) => c.v != undefined && c.v > 0 }
        )

        //hypsometric tints style
        const colors = ["#bbcc9e", "#dde4c7", "#e0ebd9", "#e9f0d1", "#ece8c1", "#e9d6ad", "#e7c18c", "#e2b470", "#dda255", "#de8f4e", "#d57751", "#c8705e", "#d38487", "#dca3a4", "#edc7c2"]
        const classNumber = colors.length
        const hypsoStyle = new gridviz.SquareColorCategoryWebGLStyle({
            viewScale: cells => {
                [min, max] = d3.extent(cells, c => c.v)
                const breaks = []
                for (let i = 1; i < classNumber; i++) breaks.push(min + (max - min) * i / classNumber)
                return gridviz.classifier(breaks)
            },
            code: (c, r, z, classifier) => classifier(c.v),
            color: { ...colors },
        })

        //add layer to map
        map.layers = [
            new gridviz.GridLayer(dataset, [hypsoStyle, new gridviz.ShadingRayStyle({ elevation: c => c.v })], {
                minPixelsPerCell: 2,
                cellInfoHTML: (c) => `Elevation: ${c.v} m`
            })
        ]

        const update = () => {

            //get shading style
            const style = map.layers[0].styles[1]

            //set shading style parameters based on GUI values
            style.visible = document.getElementById("cbHillshadingRay").checked ? () => true : () => false
            style.alpha = () => document.getElementById("sAlpha").value
            style.sunAltitude = () => document.getElementById("sunAltitude").value
            style.sunAzimuth = () => document.getElementById("sunAzimuth").value
            style.zFactor = () => document.getElementById("zFactor").value

            map.redraw()
        }

        //add form event listener
        document.getElementById("form").addEventListener('input', update);
        update()

    </script>
</body>

</html>