<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title></title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="viz-container" style="height: 100%; width: 100%"></div>

    <div style="
                position: absolute;
                left: 20px;
                top: 20px;
                width: auto;
                height: auto;
                padding: 10px;
                border: 0px;
                border-radius: 5px;
                background: #ffffffcc;
                line-height: 1.6;
                box-shadow: 5px 5px 5px grey;
            ">
        <select id="type" style="font-size: 1em">
            <option value="flag_v">Flag vertical</option>
            <option value="flag_h">Flag horizontal</option>
            <option value="piechart">Pie chart</option>
            <option value="ring" selected>Ring</option>
            <option value="segment_v">Segment vertical</option>
            <option value="segment_h">Segment horizontal</option>
            <option value="radar">Radar</option>
            <option value="halftone">Halftone</option>
            <option value="agepyramid">Age pyramid</option>
            <option value="random">Random</option>
        </select>
        <br />
        <input type="checkbox" id="size" checked />
        <label for="size" style="font-size: 1em">Size</label>
    </div>

    <script src="../../dist/gridviz.js"></script>
    <script>
        let containerDiv = document.getElementById('viz-container')
        const map = new gviz.Map(containerDiv)
            .setGeoCenter({ x: 3951000, y: 2255603 })
            .setZoom(10)
            .setZoomExtent([4, 2000])
            //.setBackgroundColor("black")
            .addMultiScaleTiledGridLayer(
                [200, 400, 600, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'https://raw.githubusercontent.com/jgaffuri/tiled-grid-france-filosofi/main/out/csv/met/men/2019/' +
                    r +
                    'm/',
                [
                    new gviz.CompositionStyle({
                        color: {
                            men_1ind: '#7570b3',  //blue
                            men_2_4ind: '#1b9e77', //green
                            men_5ind: '#d95f02', //orange
                        },
                        type: () => 'ring',
                        stripesOrientation: () => 0,
                        size: (c, r, zf, scale) => scale(+c.men),
                        viewScale: gviz.sizeQuantileScale({ valueFunction: (c) => +c.men, classNumber: 5, minSizePix: 8 }),
                        offsetAngle: () => 90,
                    }),
                ],
                {
                    minPixelsPerCell: 18,
                    preprocess: (c) => {
                        c.men_2_4ind = +c.men - +c.men_1ind - +c.men_5ind
                    },
                }
            )

        //type selection
        const s = map.layers[0].styles[0]
        document.getElementById('type').addEventListener('change', function () {
            const v = this.value

            //set type
            const type = v.includes('flag') ? 'flag' : v.includes('segment') ? 'segment' : v
            if (type === 'random')
                s.type = () => {
                    const r = Math.random()
                    return r < 2 / 9
                        ? 'flag'
                        : r < 3 / 9
                            ? 'piechart'
                            : r < 4 / 9
                                ? 'ring'
                                : r < 6 / 9
                                    ? 'segment'
                                    : r < 7 / 9
                                        ? 'radar'
                                        : r < 8 / 9
                                            ? 'halftone'
                                            : 'agepyramid'
                }
            else s.type = () => type

            //set orientation
            const or = v.includes('h') ? 0 : v.includes('v') ? 90 : 90
            if (type === 'random') s.stripesOrientation = () => (Math.random() < 0.5 ? 0 : 90)
            else s.stripesOrientation = () => or

            //redraw
            map.cg.redraw()
        })

        //size
        document.querySelector('#size').addEventListener('change', function () {
            //set size
            s.size = this.checked
                ? (c, r, zf, scale) => scale(+c.men)
                : (c, r) => r
            //redraw
            map.cg.redraw()
        })
    </script>
</body>

</html>