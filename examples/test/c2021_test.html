<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
    <title>Gridviz - Custom style</title>
</head>

<body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
    <div id="viz-container" style="height: 100%; width: 100%"></div>

    <script src="../../dist/gridviz.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
    <script>
        let containerDiv = document.getElementById('viz-container')

        //generic function for quantile color maps
        //valueFunction, exponent, colorRamp
        const colorScale = (opts) => {
            const valueFunction = opts.valueFunction
            const exponent = opts.exponent || 0.5
            const colorRamp = opts.colorRamp || (() => "purple")
            const scale = d3.scaleSequentialPow().exponent(exponent).interpolator(colorRamp)
            return (cells, r, zf) => {
                scale.domain(d3.extent(cells, valueFunction))
                return scale;
            }
        }

        //generic function for quantile color maps
        //valueFunction, classNumber, colorRamp
        const colorQuantileScale = (opts) => {
            const valueFunction = opts.valueFunction
            const classNumber = opts.classNumber || 12
            const colorRamp = opts.colorRamp || (() => "purple")
            const scale = d3.scaleQuantile().range(Array.from({ length: classNumber }, (_, i) => colorRamp(i / (classNumber - 1))))
            return (cells) => {
                scale.domain(cells.map(valueFunction));
                return scale;
            }
        }

        //generic function for size map
        //valueFunction, exponent, minValue, minSizePix, maxSizeFactor
        const sizeScale = (opts) => {
            const valueFunction = opts.valueFunction
            const exponent = opts.exponent || 0.5
            const minValue = opts.minValue || 0
            const minSizePix = opts.minSizePix || 0
            const maxSizeFactor = opts.minSizePix || 1.41
            const scale = d3.scalePow().exponent(exponent)
            return (cells, r, zf) => {
                scale.domain([minValue, d3.max(cells, valueFunction)])
                scale.range([minSizePix * zf, r * maxSizeFactor])
                return scale;
            }
        }

        //generic function for size map - quantile
        //valueFunction, classNumber, minSizePix, maxSizeFactor
        const sizeQuantileScale = (opts) => {
            const valueFunction = opts.valueFunction
            const classNumber = opts.classNumber || 12
            const minSizePix = opts.minSizePix || 1
            const maxSizeFactor = opts.maxSizeFactor || 1
            const scale = d3.scaleQuantile()
            return (cells, r, zf) => {
                scale.domain(cells.map(valueFunction))
                const minSizeGeo = minSizePix * zf, maxSizeGeo = r * maxSizeFactor
                scale.range(Array.from({ length: classNumber }, (_, i) => minSizeGeo + i * (maxSizeGeo - minSizeGeo) / (classNumber - 1)))
                return scale;
            }
        }



        //style

        //total population - color
        const styleTotalColor = new gviz.ShapeColorSizeStyle_({
            color: (c, r, zf, scale) => scale(c.T),
            viewContext: colorQuantileScale({ valueFunction: (c) => +c.T, classNumber: 12, colorRamp: d3.interpolateYlOrRd })
        })

        //total population - size
        const styleTotalSize = new gviz.ShapeColorSizeStyle_({
            size: (c, r, zf, scale) => scale(+c.T),
            shape: () => "circle",
            viewContext: sizeScale({ valueFunction: (c) => +c.T, exponent: 0.35 })
        })

        //total population - size quantile
        const styleTotalSizeQ = new gviz.ShapeColorSizeStyle_({
            size: (c, r, zf, scale) => scale(+c.T),
            shape: () => "circle",
            viewContext: sizeQuantileScale({ valueFunction: (c) => +c.T, classNumber: 10, minSizePix: 3, maxSizeFactor: 1.1 })
        })

        const vcCombine = (obj) => {
            return (cells, r, zf) => {
                return {}
            }
        }

        //by sex
        //TODO vc combine?
        const colorScaleSex = colorQuantileScale({ valueFunction: (c) => +c.indMF, classNumber: 12, colorRamp: d3.interpolateSpectral })
        const sizeScaleSex = sizeQuantileScale({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 3, maxSizeFactor: 1 })
        const styleSex = new gviz.ShapeColorSizeStyle_({
            color: (c, r, zf, vc) => vc.colorScale(c.indMF),
            size: (c, r, zf, vc) => vc.sizeScale(c.T),
            viewContext: (cells, r, zf) => ({ colorScale: colorScaleSex(cells, r, zf), sizeScale: sizeScaleSex(cells, r, zf) }),
            shape: () => 'circle',
        })

        //by employment rate
        //TODO vc combine?
        const colorScaleEmp = colorQuantileScale({ valueFunction: (c) => +c.remp, classNumber: 12, colorRamp: d3.interpolateYlOrRd })
        const sizeScaleEmp = sizeQuantileScale({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 3, maxSizeFactor: 1 })
        const styleEmp = new gviz.ShapeColorSizeStyle_({
            color: (c, r, zf, vc) => vc.colorScale(c.remp),
            size: (c, r, zf, vc) => vc.sizeScale(c.T),
            viewContext: (cells, r, zf) => ({ colorScale: colorScaleEmp(cells, r, zf), sizeScale: sizeScaleEmp(cells, r, zf) }),
            shape: () => 'circle',
        })

        //by age
        const colAge = d3.interpolateSpectral
        const styleAge = new gviz.CompositionStyle_({
            color: {
                Y_LT15: colAge(0.2),
                "Y15-64": colAge(0.4),
                Y_GE65: colAge(0.9),
            },
            type: () => 'flag',
            size: (c, r, zf, scale) => scale(+c.T),
            viewContext: sizeQuantileScale({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 8, maxSizeFactor: 1 }),
            //viewContext: sizeScale({ valueFunction: (c) => +c.T, exponent: 0.1 }),
            stripesOrientation: () => 90
        })

        //place of birth
        const styleBirthPlace = new gviz.CompositionStyle_({
            color: {
                NAT: "#fed9a6", //light mostard
                EU_OTH: "#7570b3", //blueish
                OTH: "#d95f02", //orange
            },
            type: () => 'halftone', //flag, piechart, ring, segment, radar, agepyramid, halftone
            size: (c, r, zf, scale) => scale(+c.T),
            viewContext: sizeQuantileScale({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 8, maxSizeFactor: 1 }),
        })

        //mobility
        const styleMobility = new gviz.CompositionStyle_({
            color: {
                SAME: "#fed9a6", //light mostard
                CHG_IN: "#7570b3", //blueish
                CHG_OUT: "#d95f02", //orange
            },
            type: () => 'piechart', //flag, piechart, ring, segment, radar, agepyramid, halftone
            size: (c, r, zf, scale) => scale(+c.T),
            viewContext: sizeQuantileScale({ valueFunction: (c) => +c.T, classNumber: 5, minSizePix: 8, maxSizeFactor: 1 }),
        })


        const style = styleEmp
        const pixNb = 5

        /*
        "T" >= Total population

        "F" >= Women
        "M" >= Men

        "Y_LT15" >= Age under 15 years
        "Y15-64" >= Age 15 to 64 years
        "Y_GE65" >= Age 65 years and older

        "EMP" >= Employed (working population)

        "NAT" >= Born in the country
        "EU_OTH" >= Born in another EU member state
        "OTH" >= Born outside the EU

        "SAME" >= Residence unchanged (as of January 1, 2021, compared to January 1, 2020)
        "CHG_IN" >= Moved within the Netherlands (as of January 1, 2021, compared to January 1, 2020)
        "CHG_OUT" >= Moved from outside the Netherlands (as of January 1, 2021, compared to January 1, 2020)
        */



        //make application with custom style
        new gviz.App(containerDiv)
            .setGeoCenter({ x: 4598000, y: 2715000 })
            .setZoomFactor(700)
            .addMultiScaleTiledGridLayer(
                [1000, 2000, 5000, 10000, 20000, 50000, 100000],
                (r) =>
                    'http://localhost:1234/' +
                    r +
                    'm/',
                [style],
                {
                    pixNb: pixNb,
                    preprocess: (c) => {
                        if (!c.T || +c.T == 0) return false

                        //male/female index
                        //if (+c.F + +c.M != c.T) console.error("Error found in sex total")
                        c.indMF = +c.M - (+c.F)
                        c.indMF = (100 * c.indMF) / (+c.M + +c.F)
                        if (isNaN(c.indMF)) c.indMF = 0

                        //employment
                        c.remp = c.EMP / c.T * 100
                        if (c.remp < 0 || c.remp > 100) console.log("Unexpected employment rate: " + c.remp, c.EMP, c.T)
                        c.remp = c.remp > 100 ? 100 : c.remp < 0 ? 0 : c.remp
                    }
                }

            )

    </script>
</body>

</html>